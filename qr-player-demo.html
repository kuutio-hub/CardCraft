<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CardCraft Zenelejátszó Demó</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            --spotify-green: #1DB954;
            --dark-bg: #121212;
            --light-text: #ffffff;
            --medium-text: #b3b3b3;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--light-text);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }

        .hidden {
            display: none !important;
        }
        
        #start-button, #reset-button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: black;
            background-color: var(--spotify-green);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #start-button:active, #reset-button:active {
            transform: scale(0.95);
        }

        #scanner-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
        }
        
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #scanner-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: 50px solid rgba(0,0,0,0.6);
            box-sizing: border-box;
        }

        #instruction-container h1, #playing-container h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--light-text);
        }

        #instruction-container i, #playing-container i {
            font-size: 5rem;
            color: var(--spotify-green);
            margin-bottom: 30px;
            display: block;
            animation: pulse 2s infinite ease-in-out;
        }
        
        #instruction-container p, #playing-container p {
            font-size: 1.2rem;
            color: var(--medium-text);
            max-width: 80%;
            margin: 0 auto;
        }

        #status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="start-container" class="container">
        <h1>CardCraft Lejátszó</h1>
        <p style="margin-bottom: 30px; color: var(--medium-text);">Olvass be egy kártyát a zene meghallgatásához.</p>
        <button id="start-button">Szkennelés indítása</button>
    </div>

    <div id="scanner-container" class="hidden">
        <video id="scanner-video" playsinline></video>
        <div id="scanner-overlay"></div>
    </div>
    
    <div id="instruction-container" class="container hidden">
        <i class="fa-solid fa-mobile-screen-button"></i>
        <h1>Sikeres beolvasás!</h1>
        <p>A zene indításához fordítsd le a telefont arccal lefelé.</p>
    </div>
    
    <div id="playing-container" class="container hidden">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        <h1>Zene lejátszása...</h1>
        <p id="song-url" style="font-size: 0.8rem; word-break: break-all;"></p>
        <button id="reset-button" class="hidden" style="margin-top: 30px;">Új kártya</button>
    </div>

    <div id="status" class="hidden"></div>
    <audio id="audio-player"></audio>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const startContainer = document.getElementById('start-container');
        const startButton = document.getElementById('start-button');
        
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('scanner-video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        const instructionContainer = document.getElementById('instruction-container');
        const playingContainer = document.getElementById('playing-container');
        const songUrlDisplay = document.getElementById('song-url');
        const resetButton = document.getElementById('reset-button');
        
        const audioPlayer = document.getElementById('audio-player');
        const statusDiv = document.getElementById('status');
        
        let stream = null;
        let animationFrameId = null;
        let scannedUrl = null;

        function showStatus(message) {
            statusDiv.classList.remove('hidden');
            statusDiv.textContent = message;
        }
        
        async function requestPermissions() {
             // iOS 13+ requires explicit permission for DeviceMotionEvent
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert('A giroszkóp használata elutasítva. A "fordítsd le" funkció nem fog működni.');
                        return false;
                    }
                } catch (error) {
                    console.error('Hiba a giroszkóp engedélykérés közben:', error);
                    alert('Hiba a giroszkóp engedélykérés közben. Próbáld újra betölteni az oldalt.');
                    return false;
                }
            }
            return true;
        }

        async function startScan() {
            try {
                const hasMotionPermission = await requestPermissions();
                if (!hasMotionPermission && navigator.userAgent.includes("iPhone")) return;

                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    startContainer.classList.add('hidden');
                    scannerContainer.classList.remove('hidden');
                    animationFrameId = requestAnimationFrame(tick);
                };
            } catch (err) {
                console.error("Kamera hiba:", err);
                alert("Nem sikerült elérni a kamerát. Engedélyezd a böngészőben a hozzáférést!");
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    handleQRCode(code.data);
                    return; // Stop the loop
                }
            }
            animationFrameId = requestAnimationFrame(tick);
        }

        function handleQRCode(url) {
            stopScan();
            scannedUrl = url;
            scannerContainer.classList.add('hidden');
            instructionContainer.classList.remove('hidden');
            listenForFlip();
        }

        function stopScan() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function deviceOrientationHandler(event) {
            // beta is the front-to-back tilt.
            // When held upright, it's around 90.
            // When face down on a table, it's > 160.
            const beta = event.beta;
            // showStatus(`Beta: ${beta.toFixed(2)}`); // Debugging
            if (beta > 160) {
                window.removeEventListener('deviceorientation', deviceOrientationHandler);
                playMusic();
            }
        }

        function listenForFlip() {
            window.addEventListener('deviceorientation', deviceOrientationHandler);
        }

        function playMusic() {
            instructionContainer.classList.add('hidden');
            playingContainer.classList.remove('hidden');
            songUrlDisplay.textContent = scannedUrl;
            
            audioPlayer.src = scannedUrl;
            audioPlayer.play().catch(e => {
                console.error("Lejátszási hiba:", e);
                alert("Hiba a zene lejátszása közben.");
            });
            
            audioPlayer.onended = () => {
                playingContainer.querySelector('h1').textContent = "Vége";
                playingContainer.querySelector('i').className = "fa-solid fa-check-circle";
                resetButton.classList.remove('hidden');
            };
        }

        function resetApp() {
            playingContainer.classList.add('hidden');
            resetButton.classList.add('hidden');
            startContainer.classList.remove('hidden');
            
            playingContainer.querySelector('h1').textContent = "Zene lejátszása...";
            playingContainer.querySelector('i').className = "fa-solid fa-circle-notch fa-spin";
            scannedUrl = null;
        }

        startButton.addEventListener('click', startScan);
        resetButton.addEventListener('click', resetApp);
    </script>
</body>
</html>
